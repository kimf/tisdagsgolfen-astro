---
export const prerender = false;
import { getaActiveSessions } from 'src/db/queries/getActiveSessions';
import type { ActiveSession } from 'src/db/queries/getActiveSessions';
import Button from 'src/components/ui/button.astro';
import EventCard from 'src/components/homepage/EventCard.astro';
import Link from 'src/assets/icons/link.svg';
import getDb from 'src/db';

const userId = await Astro.session?.get('userId');
const scoringSessions = await getaActiveSessions(getDb(Astro.locals));

type SessionGroupKey = string;
const groupedSessionsObj: Record<SessionGroupKey, ActiveSession[]> = {};
for (const sesh of scoringSessions) {
  const key: SessionGroupKey = `${sesh.strokes}|${sesh.special}|${sesh.teamEvent}|${sesh.courseId}`;
  if (!groupedSessionsObj[key]) {
    groupedSessionsObj[key] = [];
  }
  groupedSessionsObj[key].push(sesh);
}
const groupedSessions: ActiveSession[][] = Object.values(groupedSessionsObj);

const ownedScoringSession = userId
  ? scoringSessions.find((sesh) => sesh.ownerId === Number(userId))
  : null;

const hasFinishedSession = ownedScoringSession && ownedScoringSession.state === 'PENDING';
const scoringSession = ownedScoringSession || scoringSessions[0];
---

{
  userId && !ownedScoringSession && groupedSessions.length === 0 && (
    <Button class="absolute right-0 top-3" size="sm">
      <a href="/scoring/new">NY RUNDA</a>
    </Button>
  )
}
{
  scoringSession && (
    <EventCard
      date={scoringSession.createdAt || ''}
      special={!!scoringSession.special}
      strokes={!!scoringSession.strokes}
      teamEvent={!!scoringSession.teamEvent}
      live
    >
      <div id={`scoringSession.${scoringSession.id}`} class="flex justify-between">
        <a
          href={
            !ownedScoringSession
              ? `/scoring/new?joinId=${scoringSession.id}`
              : `/scoring/${scoringSession.id}`
          }
        >
          <Button size="xs" intent="default" class="absolute bottom-2 left-2">
            {hasFinishedSession ? 'REDIGERA' : ownedScoringSession ? 'FORTSÄTT' : 'FÖR SCORE'}
          </Button>
        </a>
      </div>

      <a href={`/scoring/${scoringSession.id}/leaderboard`} class="absolute bottom-2 right-2">
        <Link class="size-5" />
      </a>
    </EventCard>
  )
}
