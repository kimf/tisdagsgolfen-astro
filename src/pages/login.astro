---
import HeaderTitle from 'src/components/shared/HeaderTitle.astro';
import StickyHeader from 'src/components/shared/StickyHeader.astro';
import Button from 'src/components/ui/button.astro';
import db from 'src/db';
import AppScreen from 'src/layouts/AppScreen.astro';
import { shortName } from 'src/lib/formatters';

const errors = { password: '' };

if (Astro.request.method === 'GET') {
  const userId = await Astro.session?.get('userId');
  if (userId) {
    return Astro.redirect('/');
  }
}

if (Astro.request.method === 'POST') {
  try {
    const formData = await Astro.request.formData();
    const userId = formData.get('userId');
    const password = formData.get('password');

    // Replace with your actual password check logic
    if (password === import.meta.env.USER_PASSWORD) {
      await Astro.session?.set('userId', String(userId));
      return Astro.redirect('/');
    } else {
      errors.password = 'Fel lösenord!';
    }
  } catch (error) {
    if (error instanceof Error) {
      console.error(error.message);
    }
  }
}

const players = await db.query.profiles.findMany({
  orderBy: (p, { desc }) => [desc(p.avatarUrl)]
});
---

<AppScreen title="Logga in" back="/">
  <div class="flex min-h-svh w-full  p-6 md:p-10">
    <div class="w-full">
      <HeaderTitle title="VÄLJ KARAKTÄR" />

      {errors.password && <p style="color: red;">{errors.password}</p>}
      <form method="post" class="login" x-data="login">
        <div class="flex gap-4">
        <input type="hidden" name="userId" x-model="userId" required />
        <div class="flex flex-wrap gap-4 flex-1/4">
          {
            players.map((player) => (
              <div class="flex flex-col relative" x-transition  x-on:click={`toggleUserId(${player.id})`} :class={`[
                isUser(${player.id}) ? 'selected' : '',
                isAnotherUser(${player.id}) ? 'hidden' : ''
              ]`}>
                <div class="holo-checkbox">
                  {player.avatarUrl === '1' ? (
                    <img src={`/images/avatars/${player.id}.png`} />
                  ) : (
                    <img src="/images/avatars/default.png" />
                  )}
                  <span class="text-sm uppercase">{shortName(player.fullName)}</span>
                  <div class="holo-glow"></div>
                </div>
              </div>
            ))
          }
        </div>

        <div
          class="flex-col flex gap-4 flex-3/4"
          x-show="canLogin()"
          x-cloak
          x-transition>
          <input
            type="password"
            id="password"
            name="password"
            placeholder="hemligt!"
            required
            minlength="3"
            class="bg-white border p-2 text-black"
          />

          <Button size="lg" :disabled="!canLogin()" type="submit">LOGGA IN</Button>
        </div>
        </div>
      </form>
    </div>
  </div>
  <script src="src/assets/alpine//LoginController.ts"></script>
</AppScreen>


<style>
.holo-checkbox {
  position: relative;
  width: 100px;
  height: 120px;
  cursor: pointer;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;

  padding: 4px;
}

.holo-glow {
  position: absolute;
  width: 200%;
  height: 200%;
  left: -50%;
  top: -50%;
  background: radial-gradient(
    ellipse at center,
    rgba(0, 162, 255, 0.2) 0%,
    rgba(0, 162, 255, 0.1) 40%,
    rgba(0, 0, 0, 0) 70%
  );
  pointer-events: none;
  filter: blur(20px);
  opacity: 0.5;
  z-index: -1;
}

.selected {
  .holo-glow {
    background: radial-gradient(
      ellipse at center,
      rgba(0, 255, 136, 0.2) 0%,
      rgba(0, 255, 136, 0.1) 40%,
      rgba(0, 0, 0, 0) 70%
    );
  }

  border-color: rgba(0, 255, 136, 0.7);
  border-radius: 3px;
  border-width: 2px;
}
</style>
